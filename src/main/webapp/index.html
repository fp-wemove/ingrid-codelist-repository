<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
        <title>InGrid CodeLists Administration</title>
        
        <script type="text/javascript" src="js/dojo/dojo/dojo.js" data-dojo-config="parseOnLoad: true"></script>
        <script type="text/javascript" src="js/dialogs.js"></script>
        
        <link rel="stylesheet" href="js/dojo/dojo/resources/dojo.css">
        <link rel="stylesheet" href="js/dojo/dijit/themes/claro/claro.css">
        <link rel="stylesheet" href="js/dojo/dojox/grid/resources/Grid.css">
        <link rel="stylesheet" href="js/dojo/dojox/grid/resources/claroGrid.css">
        <!-- <link rel="stylesheet" type="text/css" href="../lib/extjs/resources/css/ext-all.css" /> -->
        
        <style type="text/css" media="screen">
            body, html { width:100%; height:100%; margin:0; padding:0; overflow:hidden; }
            #content{ width:100%; height:100% }
            h1 {margin:0; padding:10px;text-decoration: underline;}
            td {vertical-align: top;}
            .buttonLayer {padding-top: 10px;}
            .error .dijitDialogTitleBar {background-color: red;}
        </style>
        
        <script type="text/javascript">
            var thereAreChanges     = false;
            var currentCodelist     = -1;
            var currentEntryClicked = null;
            
            var languageStore;
            var languageMap         = {};
            
            require([
                "dojo/store/JsonRest",
                "dojox/grid/DataGrid",
                "dojo/data/ObjectStore",
                "dojo/data/ItemFileReadStore",
                "dojo/data/ItemFileWriteStore",
                "dijit/form/ValidationTextBox",
                "dijit/form/SimpleTextarea",
                "dijit/form/Button",
                "dijit/form/FilteringSelect",
                "dijit/layout/BorderContainer",
                "dijit/layout/ContentPane",
                "dojox/widget/Standby",
                "dojox/grid/cells/dijit",
                "dojo/ready", "dojo/on"], function(JsonRest, DataGrid, ObjectStore) {
                    
                languageStore = new dojo.data.ItemFileReadStore({url:'data/languages.json'});
                languageStore.fetch();
            });
            
            dojo.ready(function() {
                dojo.connect(clSelect,       "onChange",        showCodeList);
                dojo.connect(entriesGrid,    "onRowClick",      showEntry);
                dojo.connect(entryIdTextbox, "onBlur",          updateEntryId);
                
                entryIdTextbox.validator = function(val) {if (idExists(val)) return false; else return true;};
                entryIdTextbox.invalidMessage = "ID already exists!"
                
                initialObserver();
                
            });
            
            function checkChanges() {
                var def;
                
                if (thereAreChanges) {
                    // show info
                    if (currentCodelist != clSelect.item.id) {
                        var def = clDialogs.showAskDialog(clDialogs.MSG_CHANGES);
                        def.then(function() {
                            console.debug("Ignore changes!");
                        }, function() {
                            console.debug("Deletion aborted!");
                            // select previous codelist
                            clSelect.attr('value', currentCodelist, false);
                            def.cancel();
                        });
                    } else {
                        def = new dojo.Deferred();
                        def.callback();
                    }
                } else {
                    def = new dojo.Deferred();
                    def.callback();
                }
                
                return def;
            }
            
            function showCodeList(event) {
                // any changes made?
                console.debug(event);
                
                var def = checkChanges();
                
                def.then(function() {
                    console.debug("show selected codelist");
                    currentCodelist = clSelect.item.id;
                    
                    showCodelistDiv();
                    resetEntryDiv();
                    
                    // get chosen code list object
                    var activeCodelist = clSelect.item;
                    //console.debug(activeCodelist);
                    
                    // fill components with code list data
                    listIdTextbox.set("value", activeCodelist.id);
                    listNameTextbox.set("value", activeCodelist.name);
                    listDescrTextbox.set("value", activeCodelist.description);
                    
                    var newStore = new dojo.data.ItemFileWriteStore(
                        {data: {items: prepareCodelistEntries(activeCodelist)}}
                    );
                     
                    entriesGrid.setStore(newStore);
                    
                    // special handling for checkboxes
                    checkboxHandling(newStore);
                    
                    watchStore(entriesGrid.store);
                    
                    setTimeout(resetDirtyFlag, 100);
                });
            }
            
            function showEntry(event) {
                console.debug("onRowClick");
                updateListEntryData();
                
                currentEntryClicked = entriesGrid.selection.getSelected()[0];//event.rowIndex;
                
                showEntryDiv();
                
                var item = currentEntryClicked.data[0];//entriesGrid.getItem(currentEntryClicked).data[0];
                entryIdTextbox.attr("value", item.id, false);
                entryDescrTextbox.attr("value", item.description ? item.description+"" : "", false);
                
                var newStore = new dojo.data.ItemFileWriteStore(
                    {data: {items: prepareCodelistEntryLocalisation(item)}}
                );
                entryLocalisationGrid.setStore(newStore);
                
                watchStore(entryLocalisationGrid.store);
            }
            
            function showCodelistDiv() {
                dojo.style("noCodelistSelected", "display", "none");
                dojo.style("entriesContent",     "display", "block");
            }
            
            function showEntryDiv() {
                dojo.style("noEntrySelected", "display", "none");
                dojo.style("entryContent",    "display", "block");
            }
            
            function resetEntryDiv() {
                dojo.style("noEntrySelected", "display", "block");
                dojo.style("entryContent",    "display", "none");
                entriesGrid.selection.clear();
                currentEntryClicked = null;
            }
            
            function getNiceLabel(item, store) {
                if (!item.name) item.name = "Unknown";
                return item.id+" - " + item.name;
            }
            
            function updateEntryId(value) {
                console.debug("update entry: ");
                // check if id already exists ... or better use validation text box!!! 
                entriesGrid.getItem(entriesGrid.selection.selectedIndex).id = [entryIdTextbox.get("value")];
            }
            
            function addEntry() {
                var myNewItem = {id:"", localisedName:"undefined", data:[{id:"", localisations:[["",""]]}]};
                /* Insert the new item into the store:*/
                var newStoreItem = entriesGrid.store.newItem(myNewItem);
                var row = entriesGrid.getItemIndex(newStoreItem)
                entriesGrid.selection.clickSelect(row);
                showEntry({rowIndex: row});
                entryIdTextbox.focus();
            }
            
            function removeEntry() {
                var selItem = entriesGrid.getItem(entriesGrid.selection.selectedIndex);
                if (selItem) {
                    entriesGrid.store.deleteItem(selItem);
                    resetEntryDiv();
                }
            }
            
            function removeLocalisedEntry() {
                var selItem = entryLocalisationGrid.getItem(entryLocalisationGrid.selection.selectedIndex);
                if (selItem)
                    entryLocalisationGrid.store.deleteItem(selItem);
            }
            
            function addLocalisedEntry() {
                var myNewItem = {lang:"?", value:"?", 'default': false};
                /* Insert the new item into the store:*/
                entryLocalisationGrid.store.newItem(myNewItem);
            }
            
            function addCodelist() {
                var newItem = {id:"", name:"", entries:[], description:""};
                clSelect.item = newItem;
                showCodeList();
            }
            
            function removeCodelist() {
                var def = clDialogs.showAskDialog(clDialogs.MSG_DELETE_LIST);
                def.then(function() {
                    clSelect.store.remove(currentCodelist);
                    clSelect.reset();
                }, function() {
                    console.debug("Deletion aborted!");
                });
            }
            
            function cancelEdit() {
                //clSelect.store.query();
                //clSelect.reset();
                showCodeList();
                entriesGridStandby.hide();
                codelistsStandby.hide();
            }
            
            function saveChanges() {
                var selectedCodeList = clSelect.item;
                // initially set default entry to -1
                selectedCodeList.defaultEntry = "-1";
                
                updateListEntryData();
                
                var newEntries = [];
                entriesGrid.store.fetch({
                    onItem: function(item) {
                        var entry = {
                            id: item.data[0].id+"",
                            description: item.data[0].description ? item.data[0].description+"" : "", 
                            localisations: item.data[0].localisations
                        };
                        
                        // set the default localisation
                        if (item.default == "true")
                            selectedCodeList.defaultEntry = item.data[0].id+"";
                        
                        newEntries.push(entry);
                    }
                });
                
                
                selectedCodeList.name           = listNameTextbox.get("value");
                selectedCodeList.description    = listDescrTextbox.get("value");
                selectedCodeList.entries        = newEntries;
                
                var def = clSelect.store.put(selectedCodeList, {id: listIdTextbox.get('value'), name:"hallo"});
                def.then(
                    function(result) {
                        clDialogs.showDialog(clDialogs.TYPE_OK, clDialogs.MSG_SAVE_SUCCESS);
                        showCodeList();
                    },
                    function(err) {
                        console.debug("Error while saving!");
                        clDialogs.showDialog(clDialogs.TYPE_ERROR, clDialogs.MSG_SAVE_ERROR);
                        console.debug(err);
                    }
                );
                
                
            }
            
            /* DATA PREPARER */
            function prepareCodelistEntries(cl) {
                var data = [];
                dojo.forEach(cl.entries, function(item) {
                    var entry = {id: item.id};
                    entry.localisedName = getLocalisedEntryName(item.localisations);
                    entry.default = (cl.defaultEntry == item.id) ? true : false
                    entry.data = item;
                    data.push(entry);
                });
                return data;
            }
            
            function prepareCodelistEntryLocalisation(entry) {
                var data = [];
                dojo.forEach(entry.localisations, function(local) {
                    var locEntry = {lang: local[0], value: local[1]};
                    data.push(locEntry);
                });
                return data;
            }
            
            function getLocalisedEntryName(localisations) {
                if (localisations.length === 0)
                    return "undefined";
                    
                var result = localisations[0][1];
                dojo.forEach(localisations, function(local) {
                    if (local[0] == "en") result = local[1];
                });
                return result;
            };
            
            function getEntry(entries, id) {
                return dojo.filter(entries, function(entry) { return entry.id == id ? true : false; })
            }
            
            
            /* EVENT NOTIFIERS */
            function initialObserver() {
                //require(["dojo/on"], function(on) {
                //    myEvent = on.pausable(listIdTextbox, "change", function() {console.debug("pausable id changed");setDirtyFlag();});
                //});
                dojo.connect(entryIdTextbox,   "onChange", setDirtyFlag);
                dojo.connect(listIdTextbox,    "onChange", setDirtyFlag);
                dojo.connect(listNameTextbox,  "onChange", setDirtyFlag);
                dojo.connect(listDescrTextbox, "onChange", setDirtyFlag);
                dojo.connect(entryDescrTextbox, "onChange", setDirtyFlag);
            }
           
            function watchStore(store) {
                dojo.connect(store, "onSet",    setDirtyFlag);
                dojo.connect(store, "onNew",    setDirtyFlag);
                dojo.connect(store, "onDelete", setDirtyFlag);
            }
            
            function updateListEntryData() {
                // if nothing has been selected before
                if (currentEntryClicked === null)
                    return;
                    
                console.debug("updateListEntryData");
                    
                var origItem = currentEntryClicked;//entriesGrid.getItem(currentEntryClicked);
                var data = origItem.data[0];
                data.id = entryIdTextbox.get('value');
                data.description = entryDescrTextbox.get('value'); 
                data.localisations = [];
                entryLocalisationGrid.store.fetch({
                    onItem: function(item) {
                        data.localisations.push([item.lang+"", item.value+""]);
                    }
                });
            }
            
            function setDirtyFlag(arg1, arg2, arg3) {
                thereAreChanges = true;
                btnSave.set("disabled", false);
            }
            
            function resetDirtyFlag() {
                thereAreChanges = false;
                btnSave.set("disabled", true);
            }
            
            /* VALIDATORS */
            function idExists(newId) {
                var invalid = false;
                
                // id not empty!
                if (newId == "")
                    invalid = true;
                
                // get old id from selected entry
                var selItem = entriesGrid.getItem(entriesGrid.selection.selectedIndex);
                entriesGrid.store.fetch({
                    onItem: function(item) {
                        if (item != selItem) {
                            if (item.id == newId) {
                                invalid = true;
                            }
                        }
                    }
                });
               
                if (invalid) {
                    entriesGridStandby.show();
                    codelistsStandby.show();
                } else {
                    entriesGridStandby.hide();
                    codelistsStandby.hide();
                }
               
                return invalid;
            }
            
            function checkboxHandling(store) {
                dojo.connect(store, "onSet", function(item, attribute, oldValue, newValue) {
                    if (attribute == "default" && newValue == true && oldValue == false) {
                        // make sure no other checkboxes are selected!
                        entriesGrid.store.fetch({
                            onItem: function(otherItem) {
                                if (item != otherItem && (otherItem.default == "true")) {
                                    entriesGrid.store.setValue(otherItem, "default", false);
                                }
                            }
                        });
                        // update grid
                        entriesGrid.render();
                    }
                });
            }
           
            /* FORMATTERS */
            function showLanguage(value, rowIndex, widget) {
                var res = "?";
                widget.getWidgetProps().store.fetchItemByIdentity({
                    identity: value, 
                    onItem: function(item) {res = item ? item.name : "?";},
                    onError: function() { res = "???";}
                });
                return res;
            }
        </script>
    </head>
    <body class="claro">
        <div id="content" data-dojo-type="dijit.layout.BorderContainer" data-dojo-props="design:'headline', gutters:true, liveSplitters:true">
            <div id="topContent" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'top'" style="height: 70px;background-color: lightgray;">
                <h1 style="text-align: center;">Codelist Administration</h1>
                <div data-dojo-type="dojo.store.JsonRest" data-dojo-id="myStore" data-dojo-props="target:'/rest/getCodelists/'"></div>
                Codelists: <div jsId="clSelect" data-dojo-type="dijit.form.FilteringSelect" data-dojo-props="store:myStore, required: false, searchAttr:'name', labelFunc:getNiceLabel" style="align:center;"></div>
                <span data-dojo-type="dijit.form.Button" onclick="addCodelist()">Add</span>
                <span data-dojo-type="dijit.form.Button" onclick="removeCodelist()">Remove</span>
            </div>
            <div id="codeListContent" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="splitter:true, region:'leading'" style="width: 300px;">
                <h2>Codelist Overview</h2>
                <div id="entriesContent" style="display:none;">
                    <table style="width:100%;">
                        <tr><td>List-ID:</td><td><input id="listId" jsId="listIdTextbox" data-dojo-type="dijit.form.TextBox" data-dojo-props="intermediateChanges:true" styles="width:100%;"></td></tr>
                        <tr><td>List-Name:</td><td><input id="listName" jsId="listNameTextbox" data-dojo-type="dijit.form.TextBox"></td></tr>
                        <tr><td>Description:</td><td><input id="listDescr" jsId="listDescrTextbox" data-dojo-type="dijit.form.SimpleTextarea"></td></tr>
                    </table>
                    <div>All Entries:</div>
                    <table id="entries" jsId="entriesGrid" data-dojo-type="dojox.grid.DataGrid" keepSelection=true data-dojo-props="autoHeight:true, selectionMode:'single'" style="height: 100%; width: 100%;">
                        <thead>
                            <tr>
                                <th field="id" width="50px">ID</th>
                                <th field="localisedName" width="auto">Entry Name</th>
                                <th field="default" name="Default" width="55px" editable="true" cellType="dojox.grid.cells.Bool">Value</th>
                            </tr>
                        </thead>
                    </table>
                    <div class="buttonLayer">
                        <span data-dojo-type="dijit.form.Button" onclick="removeEntry()">Remove Entry</span>
                        <span data-dojo-type="dijit.form.Button" onclick="addEntry()">Add Entry</span>
                    </div>
                </div>
                <div id="noCodelistSelected">
                    No Codelist has been selected!
                </div>
            </div>
            <div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="splitter:true, region:'center'">
                <h2>Edit Entries</h2>
                <div id="entryContent" style="display:none;">
                    <table>
	                    <tr><td>Entry-ID::</td><td><input id="entryId" jsId="entryIdTextbox" data-dojo-type="dijit.form.ValidationTextBox" data-dojo-props="required:true"></td></tr>
	                    <tr><td>Description:</td><td><input id="entryDescr" jsId="entryDescrTextbox" data-dojo-type="dijit.form.SimpleTextarea" style="width:100%;"></td></tr>
                    </table>
                    <div>Localisations:</div>
                    <table jsId="entryLocalisationGrid" data-dojo-type="dojox.grid.DataGrid" data-dojo-props="autoHeight:true">
                        <thead>
                            <tr>
                                <th field="lang" width="100px" editable="true" cellType="dojox.grid.cells._Widget" widgetClass="dijit.form.FilteringSelect" widgetProps="{ store:languageStore}" formatter="showLanguage">Locale</th>
                                <th field="value" width="auto" editable="true">Value</th>
                            </tr>
                        </thead>
                    </table>
                    <div class="buttonLayer">
                        <span data-dojo-type="dijit.form.Button" onclick="removeLocalisedEntry()">Remove Locale</span>
                        <span data-dojo-type="dijit.form.Button" onclick="addLocalisedEntry()">Add Locale</span>
                    </div>
                </div>
                <div id="noEntrySelected">
                    No entry has been selected!
                </div>
            </div>
            <div id="actionContent" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'bottom'" style="height: 30px;background-color: lightgray;">
                <span data-dojo-type="dijit.form.Button" onclick="cancelEdit()">Cancel</span>
                <span data-dojo-id="btnSave" data-dojo-type="dijit.form.Button" onclick="saveChanges()" data-dojo-props="disabled:true">Save</span>
            </div>
        </div>
        <div data-dojo-id="codelistsStandby" data-dojo-type="dojox.widget.Standby" data-dojo-props="target:'topContent', color:'#EFEFEF', image:''">
        <div data-dojo-id="entriesGridStandby" data-dojo-type="dojox.widget.Standby" data-dojo-props="target:'codeListContent', color:'#EFEFEF', image:''">
    </body>
</html>
